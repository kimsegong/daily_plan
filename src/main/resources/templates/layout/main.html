<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/locales-all.js"></script>
<head th:replace="~{layout/header::head('Daily_Plan')}"></head>
<style>
   /* FullCalendar í™”ì‚´í‘œ ìƒ‰ìƒ ë³€ê²½ */
   .fc .fc-button {
      color: white; /* í…ìŠ¤íŠ¸ ìƒ‰ìƒì„ í°ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
      background-color: #EAD8C0; /* ë°°ê²½ ìƒ‰ìƒì„ íŒŒë€ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
      border-color: #EAD8C0; /* í…Œë‘ë¦¬ ìƒ‰ìƒë„ íŒŒë€ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
   }

   .fc .fc-button-primary:not(:disabled).fc-button-active, .fc .fc-button-primary:disabled {
      background-color: #A79277; /* í™œì„±í™”ëœ ë²„íŠ¼ì˜ ë°°ê²½ ìƒ‰ìƒ ì„¤ì • */
      border-color: #A79277; /* í™œì„±í™”ëœ ë²„íŠ¼ì˜ í…Œë‘ë¦¬ ìƒ‰ìƒ ì„¤ì • */
   }

   .fc .fc-button-primary:hover {
      background-color: #795458; /* í˜¸ë²„ ì‹œ ë²„íŠ¼ì˜ ë°°ê²½ ìƒ‰ìƒ ì„¤ì • */
      border-color: #795458; /* í˜¸ë²„ ì‹œ ë²„íŠ¼ì˜ í…Œë‘ë¦¬ ìƒ‰ìƒ ì„¤ì • */
   }

   .btn-kong {
      background-color: #EAD8C0;
   }
   .nav-link {
      font-size: large;
      color: #795458;
   }

</style>
<body>

   <div th:replace="~{layout/header::header}"></div>

   <div class="container">
      <div class="row">
         <div class="col-md-3">
            <ul class="nav flex-column">
               <li class="nav-item">
                  <a class="nav-link active" aria-current="page" href="/">CalendarğŸ—“ï¸</a>
               </li>
               <li class="nav-item">
                  <a class="nav-link" href="/">ì§€ë„?</a>
               </li>
               <li class="nav-item">
                  <a class="nav-link" href="#">ì„¤ì •</a>
               </li>
               <li class="nav-item">
                  <a class="nav-link disabled" aria-disabled="true">â¤ï¸ğŸ©·ğŸ’™ğŸ©µğŸ’œ</a>
               </li>
            </ul>
         </div>
         <div class="col-md-9">
            <div id='calendar'></div>
         </div>
      </div>
   </div>
   <!-- ìˆ˜ì •ëª¨ë‹¬ -->
   <div class="modal fade" id="editEventModal" tabindex="-1" aria-labelledby="editEventModalLabel" aria-hidden="true">
      <div class="modal-dialog">
         <div class="modal-content">
            <div class="modal-header">
               <h5 class="modal-title" id="editEventModalLabel">ì¼ì • ìˆ˜ì •</h5>
               <button type="button" class="btn-close btn-kong" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
               <form id="editEventForm">
                  <input type="hidden" id="planNo" name="planNo">

                  <!-- ì²« ë²ˆì§¸ ì¼ì • ì„¸íŠ¸ -->
                  <div class="form-group">
                     <label for="firstPlan">ì²«ë²ˆì§¸ ì¼ì •</label>
                     <input type="text" class="form-control" name="firstPlan" id="firstPlan">
                     <label for="firstComment">ë‚´ìš©</label>
                     <input type="text" class="form-control" name="firstComment" id="firstComment">
                  </div>

                  <!-- ë‘ ë²ˆì§¸ ì¼ì • ì„¸íŠ¸ -->
                  <div class="form-group">
                     <label for="secondPlan">ë‘ë²ˆì§¸ì¼ì •</label>
                     <input type="text" class="form-control" name="secondPlan" id="secondPlan">
                     <label for="secondComment">ë‚´ìš©</label>
                     <input type="text" class="form-control" name="secondComment" id="secondComment">
                  </div>

                  <!-- ì„¸ ë²ˆì§¸ ì¼ì • ì„¸íŠ¸ -->
                  <div class="form-group">
                     <label for="thirdPlan">ì„¸ë²ˆì§¸ì¼ì •</label>
                     <input type="text" class="form-control" name="thirdPlan" id="thirdPlan">
                     <label for="thirdComment">ë‚´ìš©</label>
                     <input type="text" class="form-control" name="thirdComment" id="thirdComment">
                  </div>

                  <div class="form-group">
                     <label for="startAt">ì‹œì‘ ë‚ ì§œ</label>
                     <input type="datetime-local" name="startAt"  class="form-control" id="startAt">
                  </div>
                  <div>
                     <label for="endAt" class="form-label">ëë‚ ì§œ/ì‹œê°„</label>
                     <input type="datetime-local" name="endAt"  id="endAt" class="form-control">
                  </div>
                  <div class="modal-footer">
                     <button type="button" class="btn btn-kong" id="edit_btn">ì €ì¥</button>
                     <button type="button" class="btn btn-danger" id="delete_btn">ì‚­ì œ</button>
                  </div>
               </form>
            </div>
         </div>
      </div>
   </div>





   <script th:inline="javascript">
      document.addEventListener('DOMContentLoaded', function() {
         var calendarEl = document.getElementById('calendar');
         var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
               left: 'prev,next today',
               center: 'title',
               right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            locale: 'ko',
            events: function(fetchInfo, successCallback, failureCallback) {
               fetch('/layout/plan.do')
                       .then(response => response.json())
                       .then(data => {
                          var events = data.map(plan => ({
                             id: plan.planNo,
                             title: [plan.firstPlan, plan.secondPlan, plan.thirdPlan].filter(Boolean), // ì´ë²¤íŠ¸ ì œëª©ì— ì¤„ë°”ê¿ˆ í¬í•¨
                             start: new Date(plan.startAt.replace(' ', 'T')), // ê³µë°±ì„ Të¡œ êµì²´
                             end: new Date(plan.endAt.replace(' ', 'T')),
                             extendedProps: {
                                planNo: plan.planNo,
                                details: [plan.firstComment, plan.secondComment, plan.thirdComment].filter(Boolean),
                                firstPlan: plan.firstPlan,
                                firstComment: plan.firstComment,
                                secondPlan: plan.secondPlan,
                                secondComment: plan.secondComment,
                                thirdPlan: plan.thirdPlan,
                                thirdComment: plan.thirdComment
                             }
                          }));
                          successCallback(events);
                       })
                       .catch(error => {
                          console.error('Error fetching events:', error);
                          failureCallback(error);
                       });
            },
                    eventClick: function(info) {
                           var event = info.event;
                           var modal = $('#editEventModal');
                           modal.find('#firstPlan').val(event.extendedProps.firstPlan); // ì²« ë²ˆì§¸ ê³„íš
                           modal.find('#firstComment').val(event.extendedProps.firstComment); // ì²« ë²ˆì§¸ ê³„íšì˜ ì½”ë©˜íŠ¸
                           modal.find('#secondPlan').val(event.extendedProps.secondPlan); // ë‘ ë²ˆì§¸ ê³„íš
                           modal.find('#secondComment').val(event.extendedProps.secondComment); // ë‘ ë²ˆì§¸ ê³„íšì˜ ì½”ë©˜íŠ¸
                           modal.find('#thirdPlan').val(event.extendedProps.thirdPlan); // ì„¸ ë²ˆì§¸ ê³„íš
                           modal.find('#thirdComment').val(event.extendedProps.thirdComment); // ì„¸ ë²ˆì§¸ ê³„íšì˜ ì½”ë©˜íŠ¸

                           // ë‚ ì§œ ë°ì´í„° ì„¤ì •
                           var formattedStart = event.start.toISOString().substring(0, 16); // "YYYY-MM-DDTHH:mm" í˜•ì‹
                           var formattedEnd = event.end ? event.end.toISOString().substring(0, 16) : formattedStart;

                           modal.find('#startAt').val(formattedStart);
                           modal.find('#endAt').val(formattedEnd);
                           modal.find('#planNo').val(event.extendedProps.planNo);
                           modal.modal('show'); // ëª¨ë‹¬ í‘œì‹œ
                        },
                    eventMouseEnter: function(info) {
                       // ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ íˆ´íŒìœ¼ë¡œ ê°„ë‹¨í•œ ì •ë³´ í‘œì‹œ
                       var details = info.event.extendedProps.details || 'ì—†ìŒ';
                       $(info.el).tooltip({
                          title: `${info.event.title}<br>${details}`,
                          html: true,
                          placement: 'top',
                          trigger: 'hover'
                       }).tooltip('show');
                 },
            editable: true,
            selectable: true,
            droppable: true,
            dateClick: function(info) {
               $('#eventStart').val(info.dateStr); // ë‚ ì§œ í•„ë“œë¥¼ í´ë¦­ëœ ë‚ ì§œë¡œ ì„¤ì •
               $('#eventModal').modal('show'); // ëª¨ë‹¬ ì°½ ë³´ì´ê¸°
            }
         });

         calendar.render();

         $(document).on('click', '#edit_btn', function() {
            var events = calendar.getEvents();
            var event = events.find(e => e.id === $('#planNo').val());

            if (event) {
               event.setProp('title', [$('#firstPlan').val(), $('#secondPlan').val(), $('#thirdPlan').val()].filter(Boolean).join(', '));

               // ê°œë³„ ì»¤ë©˜íŠ¸ ì—…ë°ì´íŠ¸
               event.setProp('extendedProps.firstComment', $('#firstComment').val());
               event.setProp('extendedProps.secondComment', $('#secondComment').val());
               event.setProp('extendedProps.thirdComment', $('#thirdComment').val());

               event.setStart($('#startAt').val());
               event.setEnd($('#endAt').val());

               $.ajax({
                  type: 'POST',
                  url: '/layout/modify.do',
                  data: $('#editEventForm').serialize(),
                  success: function(response) {
                     if (response.modifyResult === 1) {
                        alert('ìˆ˜ì • ì™„ë£Œ');
                        calendar.refetchEvents(); // ìº˜ë¦°ë” ì´ë²¤íŠ¸ë¥¼ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜´
                     } else {
                        alert('ìˆ˜ì • ì‹¤íŒ¨');
                     }
                     $('#editEventModal').modal('hide');
                  },
                  error: function() {
                     alert('ì„œë²„ ì˜¤ë¥˜ ë°œìƒ');
                     $('#editEventModal').modal('hide');
                  }
               });
            } else {
               alert('ìˆ˜ì •í•  ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
         });


      });

      $(document).ready(function() {
         $('#delete_btn').click(function() {
            var planNo = $('#planNo').val(); // ì‚­ì œí•  ì¼ì •ì˜ ê³ ìœ  ë²ˆí˜¸ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
            if (confirm('ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
               $.ajax({
                  url: '/layout/delete.do',
                  type: 'POST',
                  data: { planNo: planNo },
                  dataType: 'json',
                  success: function(resData) {
                     if (resData.removeResult === 1) {
                        alert('ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        $('#editEventModal').modal('hide'); // ëª¨ë‹¬ ì°½ì„ ë‹«ìŠµë‹ˆë‹¤.
                     } else {
                        alert('ì¼ì •ì´ ì‚­ì œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                     }
                  },
                  error: function() {
                     alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                  }
               });
            }
         });
      });


   </script>






   <div th:replace="~{layout/footer::footer}"></div>
</body>
</html>
