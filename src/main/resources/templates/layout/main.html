<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/locales-all.js"></script>
<head th:replace="~{layout/header::head('Daily_Plan')}"></head>
<style>
   /* FullCalendar 화살표 색상 변경 */
   .fc .fc-button {
      color: white; /* 텍스트 색상을 흰색으로 변경 */
      background-color: #EAD8C0; /* 배경 색상을 파란색으로 변경 */
      border-color: #EAD8C0; /* 테두리 색상도 파란색으로 변경 */
   }

   .fc .fc-button-primary:not(:disabled).fc-button-active, .fc .fc-button-primary:disabled {
      background-color: #A79277; /* 활성화된 버튼의 배경 색상 설정 */
      border-color: #A79277; /* 활성화된 버튼의 테두리 색상 설정 */
   }

   .fc .fc-button-primary:hover {
      background-color: #795458; /* 호버 시 버튼의 배경 색상 설정 */
      border-color: #795458; /* 호버 시 버튼의 테두리 색상 설정 */
   }

</style>
<body>

   <div th:replace="~{layout/header::header}"></div>

   <div class="container">
      <div class="row">
         <div class="col-md-3">
            <ul class="nav flex-column">
               <li class="nav-item">
                  <a class="nav-link active" aria-current="page" href="#">달력</a>
               </li>
               <li class="nav-item">
                  <a class="nav-link" href="/">ToDoList</a>
               </li>
               <li class="nav-item">
                  <a class="nav-link" href="#">설정</a>
               </li>
               <li class="nav-item">
                  <a class="nav-link disabled" aria-disabled="true">행복한하루되세연</a>
               </li>
            </ul>
         </div>
         <div class="col-md-9">
            <div id='calendar'></div>
         </div>
      </div>
   </div>
   <!-- 수정모달 -->
   <div class="modal fade" id="editEventModal" tabindex="-1" aria-labelledby="editEventModalLabel" aria-hidden="true">
      <div class="modal-dialog">
         <div class="modal-content">
            <div class="modal-header">
               <h5 class="modal-title" id="editEventModalLabel">일정 수정</h5>
               <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
               <form id="editEventForm">
                  <input type="hidden" id="planNo" name="planNo">
                  <div class="form-group">
                     <label for="firstPlan">첫번째 일정</label>
                     <input type="text" class="form-control" name="firstPlan" id="firstPlan">
                  </div>
                  <div class="form-group">
                     <label for="firstComment">내용</label>
                     <input type="text" class="form-control"  name="firstComment" id="firstComment">
                  </div>
                  <div class="form-group">
                     <label for="secondPlan">두번째일정</label>
                     <input type="text" class="form-control"  name="secondPlan" id="secondPlan">
                  </div>
                  <div class="form-group">
                     <label for="secondComment">내용</label>
                     <input type="text" class="form-control" name="secondComment" id="secondComment">
                  </div>
                  <div class="form-group">
                     <label for="thirdPlan">세번째일정</label>
                     <input type="text" class="form-control"name="thirdPlan" id="thirdPlan">
                  </div>
                  <div class="form-group">
                     <label for="thirdComment">내용</label>
                     <input type="text" class="form-control"name="thirdComment" id="thirdComment">
                  </div>
                  <div class="form-group">
                     <label for="startAt">시작 날짜</label>
                     <input type="datetime-local" name="startAt"  class="form-control" id="startAt">
                  </div>
                  <div>
                     <label for="endAt" class="form-label">끝날짜/시간</label>
                     <input type="datetime-local" name="endAt"  id="endAt" class="form-control">
                  </div>
                  <div class="modal-footer">
                     <button type="button" class="btn btn-primary" id="edit_btn">저장</button>
                  </div>
               </form>
            </div>

         </div>
      </div>
   </div>





   <script th:inline="javascript">
      document.addEventListener('DOMContentLoaded', function() {
         var calendarEl = document.getElementById('calendar');
         var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
               left: 'prev,next today',
               center: 'title',
               right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            locale: 'ko',
            events: function(fetchInfo, successCallback, failureCallback) {
               fetch('/layout/plan.do')
                       .then(response => response.json())
                       .then(data => {
                          var events = data.map(plan => ({
                             id: plan.planNo,
                             title: [plan.firstPlan, plan.secondPlan, plan.thirdPlan].filter(Boolean), // 이벤트 제목에 줄바꿈 포함
                             start: new Date(plan.startAt.replace(' ', 'T')), // 공백을 T로 교체
                             end: new Date(plan.endAt.replace(' ', 'T')),
                             extendedProps: {
                                planNo: plan.planNo,
                                details: [plan.firstComment, plan.secondComment, plan.thirdComment].filter(Boolean),
                                firstPlan: plan.firstPlan,
                                firstComment: plan.firstComment,
                                secondPlan: plan.secondPlan,
                                secondComment: plan.secondComment,
                                thirdPlan: plan.thirdPlan,
                                thirdComment: plan.thirdComment
                             }
                          }));
                          successCallback(events);
                       })
                       .catch(error => {
                          console.error('Error fetching events:', error);
                          failureCallback(error);
                       });
            },
                    eventClick: function(info) {
                           var event = info.event;
                           var modal = $('#editEventModal');
                           modal.find('#firstPlan').val(event.extendedProps.firstPlan); // 첫 번째 계획
                           modal.find('#firstComment').val(event.extendedProps.firstComment); // 첫 번째 계획의 코멘트
                           modal.find('#secondPlan').val(event.extendedProps.secondPlan); // 두 번째 계획
                           modal.find('#secondComment').val(event.extendedProps.secondComment); // 두 번째 계획의 코멘트
                           modal.find('#thirdPlan').val(event.extendedProps.thirdPlan); // 세 번째 계획
                           modal.find('#thirdComment').val(event.extendedProps.thirdComment); // 세 번째 계획의 코멘트

                           // 날짜 데이터 설정
                           var formattedStart = event.start.toISOString().substring(0, 16); // "YYYY-MM-DDTHH:mm" 형식
                           var formattedEnd = event.end ? event.end.toISOString().substring(0, 16) : formattedStart;

                           modal.find('#startAt').val(formattedStart);
                           modal.find('#endAt').val(formattedEnd);
                           modal.find('#planNo').val(event.extendedProps.planNo);
                           modal.modal('show'); // 모달 표시
                        },
                    eventMouseEnter: function(info) {
                       // 마우스 오버 시 툴팁으로 간단한 정보 표시
                       var details = info.event.extendedProps.details || '없음';
                       $(info.el).tooltip({
                          title: `${info.event.title}<br>${details}`,
                          html: true,
                          placement: 'top',
                          trigger: 'hover'
                       }).tooltip('show');
                 },
            editable: true,
            selectable: true,
            droppable: true,
            dateClick: function(info) {
               $('#eventStart').val(info.dateStr); // 날짜 필드를 클릭된 날짜로 설정
               $('#eventModal').modal('show'); // 모달 창 보이기
            }
         });

         calendar.render();

         $(document).on('click', '#edit_btn', function() {
            var events = calendar.getEvents();
            var event = events.find(e => e.id === $('#planNo').val());

            if (event) {
               event.setProp('title', [$('#firstPlan').val(), $('#secondPlan').val(), $('#thirdPlan').val()].filter(Boolean).join(', '));

               // 개별 커멘트 업데이트
               event.setProp('extendedProps.firstComment', $('#firstComment').val());
               event.setProp('extendedProps.secondComment', $('#secondComment').val());
               event.setProp('extendedProps.thirdComment', $('#thirdComment').val());

               event.setStart($('#startAt').val());
               event.setEnd($('#endAt').val());

               $.ajax({
                  type: 'POST',
                  url: '/layout/modify.do',
                  data: $('#editEventForm').serialize(),
                  success: function(response) {
                     if (response.modifyResult === 1) {
                        alert('수정 완료');
                        calendar.refetchEvents(); // 캘린더 이벤트를 다시 불러옴
                     } else {
                        alert('수정 실패');
                     }
                     $('#editEventModal').modal('hide');
                  },
                  error: function() {
                     alert('서버 오류 발생');
                     $('#editEventModal').modal('hide');
                  }
               });
            } else {
               alert('수정할 이벤트를 찾을 수 없습니다.');
            }
         });


      });




   </script>






   <div th:replace="~{layout/footer::footer}"></div>
</body>
</html>
